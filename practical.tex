\section{Practical Directory-based Implementation}\label{sec:practical}

All protocols we have discussed in~\autoref{sec:algo} need to frequently check the cache block state in other processor caches.
For instance, in MESI protocol, whenever a read miss occurs, the cache controller needs to be acknowledged if a cache holding the valid cache block value exists, to decide whether to transit the cache block state to \emph{Shared} or to \emph{Exclusive}.
In algorithmic aspect, such an operation is a constant-time basic operation.
However, if not well implemented in practice, it can become the bottleneck of the whole system.

In the beginning, cache coherency protocols are implemented with snoopy cache controllers, which monitor all transactions over a shared bus.
On a 4-core processor for personal computers, monitoring all local caches is not a significant burden for a cache controller.
However, if scaled up to a 64-core cluster, considering the limited bus bandwidth, broadcasting all transactions to each cache controller will cause severe congestion and incur nontrivial overhead.

To improve the practicability of cache coherency algorithms, directory-based solutions have been proposed as the substitution of snooping techniques.
Instead of utilizing the shared bus like snooping techniques do, directory-based techniques leverage a special \emph{directory} to maintain cache block metadata.
Each cache block has its own directory entry, which contains a bitmap recording the distribution of the cache block's copies among processors (See~\autoref{fig:impl}).
This way, cache controllers retrieve the information about which block have cache block copies by simply querying the directory rather than monitoring bus reads or bus writes.
In such a model, data are transmitted only between caches that need to share them, saving significant bus bandwidth.

\begin{figure}
    \centering
    \begin{subfigure}{.49\textwidth}
      \centering
      % \includegraphics[width=1.\textwidth]{synapse.pdf}
      \caption{Snooping}
      \hspace{10pt}
    \end{subfigure}
    \begin{subfigure}{.49\textwidth}
      \centering
      % \includegraphics[width=1.\textwidth]{MESI.pdf}
      \caption{Directory-based}
      \hspace{10pt}
    \end{subfigure}
    \caption{Differences between snooping and directory-based implementation.}
    \label{fig:impl}
\end{figure}

